# Module: Simulation Engine Core

## 1. Overview

The Simulation Engine Core is the heart of Architech, responsible for executing discrete-event simulations of distributed systems. It manages the simulation clock, processes events, and orchestrates the interactions between simulated components. Designed for high performance and extensibility, it forms the foundation upon which complex system behaviors, fault injection, and resilience patterns are built.

## 2. Key Responsibilities

*   **Event Management:** Maintains a time-ordered queue of events and dispatches them to the appropriate components at the correct simulation time.
*   **Simulation Clock:** Advances the simulation time based on the timestamps of upcoming events.
*   **Component Orchestration:** Provides a mechanism for simulated components to register, receive events, and generate new events.
*   **Performance:** Optimized for efficient event processing to handle large-scale simulations.
*   **Extensibility:** Designed with clear interfaces to allow for easy addition of new component types and simulation behaviors.
*   **Event Emission:** Publishes simulation events (e.g., request arrivals, processing completions, state changes) to an external message bus for observability and analysis.

## 3. Core Components and Files

### 3.1. `engine.go` (or `engine.py`)

*   **Description:** The main entry point and orchestrator for the simulation engine. It contains the primary simulation loop, event dispatching logic, and manages the simulation clock.
*   **Key Functions/Methods:**
    *   `Run(config SimulationConfig)`: Initializes the simulation, starts the event loop, and runs until completion or a stop condition is met.
    *   `ScheduleEvent(event Event)`: Adds a new event to the event queue.
    *   `ProcessEvent(event Event)`: Dispatches an event to the target component and processes its outcome.
    *   `AdvanceClock()`: Moves the simulation clock forward to the next event's timestamp.
*   **Interactions:** Interacts with `priority_queue.go` for event management and `component.go` for event dispatching.

### 3.2. `event.go`

*   **Description:** Defines the structure of a simulation event. Events are the fundamental units of interaction within the simulation, representing discrete occurrences at specific points in simulation time.
*   **Key Fields:**
    *   `Timestamp`: The simulation time at which the event occurs.
    *   `Type`: A string or enum indicating the type of event (e.g., `RequestArrival`, `ServiceProcessed`, `DatabaseQuery`).
    *   `SourceComponentID`: The ID of the component that generated the event.
    *   `TargetComponentID`: The ID of the component intended to receive the event.
    *   `Data`: A generic payload containing event-specific information (e.g., request ID, payload size, error details).
*   **Interactions:** Used throughout the engine and by all components to communicate.

### 3.3. `priority_queue.go`

*   **Description:** Implements a min-heap based priority queue to efficiently store and retrieve events based on their timestamp. This ensures that events are always processed in chronological order.
*   **Key Functions/Methods:**
    *   `Push(event Event)`: Adds an event to the queue.
    *   `Pop() Event`: Removes and returns the event with the smallest timestamp.
    *   `Peek() Event`: Returns the event with the smallest timestamp without removing it.
    *   `IsEmpty() bool`: Checks if the queue is empty.
*   **Interactions:** Used exclusively by `engine.go` to manage the event queue.

### 3.4. `component.go`

*   **Description:** Defines the `Component` interface, which all simulated components must implement. This interface provides a standardized way for the engine to interact with different types of components.
*   **Key Interface Methods:**
    *   `ID() string`: Returns the unique identifier of the component.
    *   `Type() string`: Returns the type of the component (e.g., 


 `GenericService`, `Database`).
    *   `HandleEvent(event Event) ([]Event, error)`: Processes an incoming event and returns a list of new events generated by the component.
    *   `Configure(config map[string]interface{}) error`: Configures the component with specific properties (e.g., processing time, capacity).
*   **Interactions:** Implemented by all concrete component types (e.g., `generic_service.go`, `database.go`). The `engine.go` interacts with components via this interface.

### 3.5. `request.go`

*   **Description:** Defines the structure of a simulated request or message that flows through the system. This is a common data payload carried by events.
*   **Key Fields:**
    *   `ID`: Unique identifier for the request.
    *   `ArrivalTime`: The simulation time when the request first entered the system.
    *   `PayloadSize`: Size of the request payload (e.g., in bytes).
    *   `Metadata`: A map for additional request-specific data (e.g., source IP, user ID).
*   **Interactions:** Carried within `Event.Data` and processed by components.

## 4. Interaction with Other Modules

*   **Simulation Orchestration Service:** Receives simulation configurations from this service and sends back simulation status updates.
*   **Observability Data Service:** Emits raw simulation events (logs, metrics, traces) to a message queue, which are then consumed and processed by the Observability Data Service.
*   **Design Service:** The simulation engine is configured based on the design retrieved from the Design Service, which defines the components and their connections.
*   **Component Library:** Utilizes components defined in the Component Library module to build the simulation graph.

## 5. Design Considerations

*   **Performance:** The core event loop and priority queue are critical for performance. Efficient data structures and algorithms are paramount.
*   **Concurrency:** The engine should be designed to handle concurrent event processing where appropriate, potentially using goroutines (Go) or async/await (Python).
*   **Determinism:** For reproducibility, simulations should be deterministic given the same initial conditions and event sequence.
*   **Extensibility:** The `Component` interface is key to allowing users and developers to easily add new types of simulated components without modifying the core engine.
*   **Error Handling:** Robust error handling within components and the engine to prevent simulation crashes and provide meaningful debugging information.

## 6. Verification

*   **Unit Tests:** Extensive unit tests for the event queue, event dispatching, and clock advancement logic.
*   **Integration Tests:** Simulate small, controlled scenarios with a few components to verify correct event flow and state changes.
*   **Performance Benchmarks:** Measure event processing rate (events/second) and memory usage under various load conditions.
*   **Determinism Checks:** Run the same simulation multiple times with identical inputs and verify identical outputs.

---

**Author:** Manus AI

**Date:** 2025-07-19


